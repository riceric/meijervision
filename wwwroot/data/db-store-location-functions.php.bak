<?php
//Connect to DB to get store info
include ("phpsqlsearch_dbinfo.php");

/** 
 * Return store info from database as array; used for locations-list.php
 */
function getStoreLocationDetailsArray($storeID) {
	global $dbUnm, $dbPwd, $db;
	// Opens a connection to a mySQL server
	$connection=mysql_connect ('localhost', $dbUnm, $dbPwd);
	if (!$connection) {
	  error_log("Not connected : " . mysql_error());
	  exit(1);
	}

	// Set the active mySQL database
	$db_selected = mysql_select_db($db, $connection);
	if (!$db_selected) {
	  error_log("Can\'t use db : " . mysql_error());
	  exit(1);
	}

	// Search the rows in the location table
	$query = "SELECT name,lat,lng,address,state,phone,hours,page_url FROM `location` WHERE id=".mysql_real_escape_string($storeID);
	$rs = mysql_query($query);

	if (!$rs) {
	  error_log("Invalid query: " . mysql_error());
	  exit(1);
	}
	
	$rows = array();
	while($result = mysql_fetch_assoc($rs)) {
		$rows[] = $result;
	}
	
	$rows[0]["services"] = getStoreServicesArray($storeID);
	$rows[0]["doctors"] = getDoctorBiosArray($storeID);

	return $rows[0];
}
/** 
 * Return store services array; used for locations-list.php
 */
function getStoreServicesArray($storeID) {
	global $dbUnm, $dbPwd, $db;
	// Opens a connection to a mySQL server
	$connection=mysql_connect ('localhost', $dbUnm, $dbPwd);
	if (!$connection) {
	  error_log("Not connected : " . mysql_error());
	  exit(1);
	}

	// Set the active mySQL database
	$db_selected = mysql_select_db($db, $connection);
	if (!$db_selected) {
	  error_log("Can\'t use db : " . mysql_error());
	  exit(1);
	}

	// Search the rows in the location table
	$query = "SELECT location_service.service_id,description FROM location_service,service WHERE location_service.service_id=service.service_id AND location_service.location_id=".mysql_real_escape_string($storeID);
	$rs = mysql_query($query);

	if (!$rs) {
	  error_log("Invalid query: " . mysql_error());
	  exit(1);
	}
	
	$rows = array();
	while($result = mysql_fetch_assoc($rs)) {
		$rows[] = $result;
	}
	return $rows;
}
/** 
 * Return store services array; used for locations-list.php
 */
function getDoctorBiosArray($storeID) {
	global $dbUnm, $dbPwd, $db;
	// Opens a connection to a mySQL server
	$connection=mysql_connect ('localhost', $dbUnm, $dbPwd);
	if (!$connection) {
	  error_log("Not connected : " . mysql_error());
	  exit(1);
	}

	// Set the active mySQL database
	$db_selected = mysql_select_db($db, $connection);
	if (!$db_selected) {
	  error_log("Can\'t use db : " . mysql_error());
	  exit(1);
	}

	// Search the rows in the location table
	$query = "SELECT location_doctor.doctor_id, full_name, doctoral_degree, bio, photo_url
				FROM location_doctor, doctor
				WHERE location_doctor.doctor_id = doctor.doctor_id
				AND location_doctor.location_id =".mysql_real_escape_string($storeID);
	$rs = mysql_query($query);

	if (!$rs) {
	  error_log("Invalid query: " . mysql_error());
	  exit(1);
	}
	
	$rows = array();
	while($result = mysql_fetch_assoc($rs)) {
		$rows[] = $result;
	}
	return $rows;
}
?>